name: Build and Package

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Qt 6.10.1 (MSVC 2022)
        uses: jurplel/install-qt-action@v3
        with:
          version: 6.10.1
          host: windows
          target: desktop
          arch: win64_msvc2022_64
          modules: qtcharts
          set-env: true


      - name: Configure CMake
        shell: cmd
        run: |
          call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat" && ^
          cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=Release

      - name: Build
        shell: cmd
        run: |
          call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat" && ^
          cmake --build build

      - name: Deploy Qt dependencies (windeployqt)
        shell: pwsh
        run: |
          Write-Host "Qt6_DIR = $Env:Qt6_DIR"

          if (-not $Env:Qt6_DIR) {
            throw "Qt6_DIR is empty — Qt installation failed."
          }

          $windeployqt = Join-Path $Env:Qt6_DIR "bin\windeployqt.exe"
          Write-Host "Using windeployqt at: $windeployqt"

          if (-not (Test-Path $windeployqt)) {
            throw "windeployqt.exe not found at $windeployqt"
          }

          $exe = Get-ChildItem build -Recurse -Filter "VehicleTelemetryGUI.exe" | Select-Object -First 1
          if (-not $exe) {
            throw "VehicleTelemetryGUI.exe not found"
          }

          Write-Host "Deploying Qt dependencies for: $($exe.FullName)"
          & $windeployqt $exe.FullName --release --compiler-runtime

      - name: Upload packaged build
        uses: actions/upload-artifact@v4
        with:
          name: VehicleTelemetryGUI
          path: build