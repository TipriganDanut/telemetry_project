name: CI Build 

on: 
  push: 
    branches: [ main ] 
  pull_request:   
jobs: 
    build: 
        runs-on: windows-latest 
        
        steps: 
          - name: Checkout 
            uses: actions/checkout@v4 

          - name: Install Qt 
            uses: jurplel/install-qt-action@v3 
            with: 
                version: 6.6.0
                host: windows 
                target: desktop 
                modules: qtcharts 
                set-env: true

          - name: Debug Qt install paths
            shell: pwsh 
            run: | 
              Write-Host "Qt6_DIR = $Env:Qt6_DIR" 
              Write-Host "Qt6_INSTALL_DIR = $Env:Qt6_INSTALL_DIR" 
              Write-Host "Qt6_DIR_FILE = $Env:Qt6_DIR_FILE" 
              if ($Env:Qt6_DIR_FILE) { Get-Content $Env:Qt6_DIR_FILE }
            
          - name: Install dependencies 
            run: | 
                choco install ninja cmake sqlite -y 
                
          - name: Configure (MSVC)
            shell: cmd
            run: |
              call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat" && ^
              cmake -S . -B build -G Ninja ^
                -DCMAKE_BUILD_TYPE=Release ^
                -DCMAKE_PREFIX_PATH="%Qt6_INSTALL_DIR%"
                
          - name: Verify build directory
            shell: pwsh
            run: |
              Test-Path build
              Get-ChildItem build

          - name: Build 
            shell: cmd 
            run: | 
              call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat" && ^
              cmake --build build --config Release 

          - name: Inspect build output
            shell: pwsh
            run: |
              Write-Host "=== CMake targets ==="
              cmake --build build --target help

              Write-Host "`n=== Files in build ==="
              Get-ChildItem build -Recurse | Select-Object FullName

          - name: Debug Qt paths
            shell: pwsh
            run: |
              Write-Host "=== Environment variables ==="
              Get-ChildItem Env: | Where-Object { $_.Name -match 'QT|Qt' } |
                Sort-Object Name |
                ForEach-Object { Write-Host "$($_.Name) = $($_.Value)" }

              Write-Host "`n=== Where is windeployqt? ==="
              where windeployqt 2>$null

              Write-Host "`n=== Where is qmake? ==="
              where qmake 2>$null

              Write-Host "`n=== Qt directory tree (shallow) ==="
              if ($Env:Qt6_DIR) {
                $qtDir = Split-Path $Env:Qt6_DIR -Parent
                Write-Host "Qt6_DIR parent = $qtDir"
                Get-ChildItem $qtDir -Depth 3 -Directory
              } else {
                Write-Host "Qt6_DIR is NOT set"
              }

              Write-Host "`n=== Full PATH (Qt-related only) ==="
              $Env:PATH -split ';' | Where-Object { $_ -match 'Qt' }

          - name: Deploy Qt dependencies
            shell: pwsh
            run: |
              $exe = Get-ChildItem build -Recurse -Filter "*.exe" |
                     Where-Object { $_.Name -eq "VehicleTelemetryGUI.exe" } |
                     Select-Object -First 1

              if (-not $exe) {
                throw "VehicleTelemetryGUI.exe not found"
              }

              Write-Host "Found executable at: $($exe.FullName)"

              if (-not $Env:Qt6_DIR) {
                throw "Qt6_DIR is not set"
              }

              # Qt6_DIR = <QtRoot>/lib/cmake/Qt6
              $qtRoot = Resolve-Path (Join-Path $Env:Qt6_DIR "..\..\..")
              $windeployqt = Join-Path $qtRoot "bin\windeployqt.exe"

              if (-not (Test-Path $windeployqt)) {
                throw "windeployqt.exe not found at $windeployqt"
              }

              Write-Host "Using windeployqt at: $windeployqt"
              & $windeployqt $exe.FullName --release --compiler-runtime
                
          - name: Upload packaged app
            uses: actions/upload-artifact@v4
            with:
              name: VehicleTelemetryGUI
              path: |
                build\
                
          - name: Run tests 
            run: ctest --test-dir build